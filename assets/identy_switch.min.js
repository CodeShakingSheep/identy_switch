
$(function(){$sw=$('#identy_switch_menu');isOk=false;switch(rcmail.env['skin']){case'larry':isOk=identy_switch_addCbLarry($sw);break;case'classic':isOk=identy_switch_addCbClassic($sw);break;case'elastic':case'hivemail':isOk=identy_switch_addCbElastic($sw);default:break;}if(isOk)$sw.show();});$(document).click(function(event){if(event.button==0){var id=event.target.id;var d=$('#identy_switch_dropdown');if(id!='identy_switch_menu'&&!d.is(':hidden'))d.hide();}});function identy_switch_init(){rcmail.addEventListener('plugin.identy_switch_notify',identy_switch_notify).addEventListener('init',function(){if(rcmail.message_list)rcmail.message_list.addEventListener('select',identy_switch_stop_notify);});}function identy_switch_addCbLarry($sw){var $truName=$('.topright .username');if($truName.length>0){if($sw.length>0){$sw.prependTo('#taskbar');$truName.hide();$('#identy_switch_menu').css('padding-top','4px').css('padding-bottom','4px');$('#identy_switch_dropdown').css('margin-left','-92px');return true;}}return false;}function identy_switch_addCbClassic($sw){var $taskBar=$('#taskbar');if($taskBar.length>0){$taskBar.prepend($sw);$('#identy_switch_menu').css('left','-10px').css('top','-5px');$('#identy_switch_dropdown').css('left','190px').css('top','-40px');return true;}return false;}function identy_switch_addCbElastic($sw){var $taskBar=$('.header-title.username');$sw.css('background-color','transparent').css('padding','4px 0 0 2rem');if($taskBar.length>0){$taskBar.prepend($sw);$taskBar.css('margin-left','20px');var $node=$('.header-title.username');var newNode=$('<'+$node[0].nodeName+'/>');$.each($node[0].attributes,function(i,attribute){newNode.attr(attribute.name,attribute.value);});$node.children().each(function(){newNode.append(this);});$node.replaceWith(newNode);$('#identy_switch_menu').css('height','30px').css('width','180px');$('#identy_switch_dropdown').css('left','9px').css('margin-top','0');return true;}return false;}function identy_switch_fixIdent(iid){if(parseInt(iid)>0)$("#_from").val(iid);}function identy_switch_toggle_menu(){var d=$('#identy_switch_dropdown');if(d.is(':hidden')){d.load(location.href+' #identy_switch_dropdown > *','');d.show();}else
d.hide();}function identy_switch_run(iid){rcmail.env.unread_counts={};rcmail.http_post('plugin.identy_switch_do',{'identy_switch_iid':iid});}function identy_switch_notify(ctl){var autoplay=decodeURI(ctl[0].autoplay);var notification=decodeURI(ctl[0].notification);var title=decodeURI(ctl[0].title);for(var i=1;i<ctl.length;i++){var e=$('#identy_switch_opt_'+ctl[i].iid);if(ctl[i].unseen=='0')e.text('');else
e.text(ctl[i].unseen);if(ctl[i].basic!==undefined)identy_switch_basic();if(ctl[i].desktop!==undefined)identy_switch_desktop(title,ctl[i].desktop.text,ctl[i].desktop.timeout,notification);if(ctl[i].sound!==undefined)identy_switch_sound(autoplay);}}function identy_switch_stop_notify(prop){if(rcmail.env.favicon_href&&rcmail.env.favicon_changed&&(!prop||prop.action!='check-recent')){$('<link rel="shortcut icon" href="'+rcmail.env.favicon_href+'"/>').replaceAll('link[rel="shortcut icon"]');rcmail.env.favicon_changed=0;}}function identy_switch_basic(){var w=rcmail.is_framed()?window.parent:window;w.focus();var src=rcmail.assets_path('plugins/identy_switch/assets');var link=$('<link rel="shortcut icon">').attr('href',src+'/alert.ico');var olink=$('link[rel="shortcut icon"]',w.document);if(!rcmail.env.favicon_href)rcmail.env.favicon_href=olink.attr('href');rcmail.env.favicon_changed=1;link.replaceAll(olink);}function identy_switch_desktop(title,msg,timeout,errmsg){if(!('Notification'in window)||window.Notification.permission!=="granted"){alert(decodeURIComponent(errmsg));window.Notification.requestPermission();return;}var popup=new window.Notification(decodeURIComponent(title),{dir:"auto",lang:"",body:decodeURIComponent(msg),icon:rcmail.assets_path('plugins/identy_switch/assets/alert.gif')});popup.onclick=function(){this.close();};setTimeout(function(){popup.close();},timeout*1000);}function identy_switch_sound(errmsg){var src=rcmail.assets_path('plugins/identy_switch/assets/alert');if(!('Notification'in window)||window.Notification.silent){alert(decodeURIComponent(errmsg));return;}if(!('Navigator'in window)&&window.Navigator.getAutoplayPolicy&&window.Navigator.getAutoplayPolicy('mediaelement')!='allowed'){alert(decodeURIComponent(errmsg));window.Notification.requestPermission();return;}new Audio(src+'.mp3').play();}